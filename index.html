<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>บันทึกนัดหมาย - A Little Wheel</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <!-- Google Fonts (Kanit) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Tom Select for Image Dropdown -->
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
    <style>
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
        }
        .form-card {
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05), 0 4px 10px rgba(0,0,0,0.05);
            padding: 0; 
        }
        /* [ไอเดีย 2] Header ดีไซน์ใหม่ */
        .form-header {
            background-color: #2c3e50; /* Dark Slate from Logo */
            padding: 1.25rem; /* p-5 */
            color: white;
        }
        .form-footer {
            background-color: #f1f5f9; /* slate-100 */
            padding: 1.25rem;
        }
        .form-content {
            padding: 1.25rem; /* p-5 */
        }
        .input-group {
            position: relative;
        }
        .input-field {
            background-color: #f8fafc; /* slate-50 */
            border-radius: 10px;
            border: 1px solid #e2e8f0; /* slate-200 */
            transition: border-color 0.2s, box-shadow 0.2s;
            padding-right: 60px;
        }
        textarea.input-field {
             padding-right: 1.25rem;
        }
        .input-field:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
            outline: none;
        }
        .input-icons {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .textarea-icons {
            position: absolute;
            right: 8px;
            top: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .icon-btn {
            cursor: pointer;
            color: #9ca3af;
            transition: color 0.2s;
            padding: 4px;
            border-radius: 50%;
        }
        .icon-btn:hover {
            color: #374151;
            background-color: #f3f4f6;
        }
        .submit-btn {
            background-color: #2c3e50;
            color: white;
            font-weight: 600;
            border-radius: 12px;
            transition: background-color 0.2s, transform 0.1s;
        }
        .submit-btn:hover {
            background-color: #34495e;
        }
        /* [ไอเดีย 3] ปุ่มกดมีชีวิตชีวา */
        .submit-btn:active {
            transform: scale(0.98);
        }
        .submit-btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        .toast {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.75);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 1000;
            transition: bottom 0.5s ease-in-out;
        }
        .toast.show {
            bottom: 30px;
        }
        /* [ไอเดีย 1] สไตล์สำหรับ Dropdown รูปภาพ */
        .ts-control {
            background-color: #f8fafc !important;
            border-radius: 10px !important;
            border: 1px solid #e2e8f0 !important;
            padding-top: 0.5rem !important;
            padding-bottom: 0.5rem !important;
        }
        .ts-control .item {
            display: flex;
            align-items: center;
        }
        .ts-control .item img, .ts-dropdown .option img {
            width: 24px;
            height: 24px;
            margin-right: 8px;
            border-radius: 50%;
            object-fit: cover;
        }
    </style>
</head>
<body class="p-4">
    <div id="loading" class="text-center text-gray-500 mt-10">กำลังโหลดข้อมูล...</div>

    <div id="liff-content" class="form-card max-w-lg mx-auto hidden overflow-hidden">
        <!-- Header -->
        <div class="form-header">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <img src="https://img2.pic.in.th/pic/52717e2ac4e89fd96e544d19865224e5.jpg" alt="A Little Wheel Logo" class="w-10 h-10 rounded-lg object-cover bg-white p-1">
                    <div>
                        <h1 class="text-xl font-bold">บันทึกนัดหมาย</h1>
                        <p id="recorder-name-display" class="text-xs text-slate-300">โดย: กำลังโหลด...</p>
                    </div>
                </div>
                <button onclick="resetForm()" class="flex items-center gap-1 text-xs text-slate-300 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    ล้างข้อมูล
                </button>
            </div>
        </div>
        
        <form id="appointment-form">
            <div class="form-content space-y-5">
                 <!-- Manual Recorder Name Input (for PC/Browser) -->
                 <div id="manual-recorder-group" class="hidden">
                    <label for="manual-recorder-name" class="flex items-center font-semibold text-gray-700 text-sm mb-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                        <span>ชื่อผู้บันทึก (กรุณากรอก)</span>
                    </label>
                    <input type="text" id="manual-recorder-name" class="w-full p-2 input-field" placeholder="กรอกชื่อของคุณ">
                </div>

                <!-- Form Fields -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div>
                        <label for="datetime" class="flex items-center font-semibold text-gray-700 text-sm mb-1">
                            <img src="https://i.ibb.co/WpncWHbt/clock.png" class="w-5 h-5 mr-2" alt="icon">
                            <span>วันที่/เวลา</span>
                        </label>
                        <input type="datetime-local" id="datetime" name="datetime" class="w-full p-2 input-field" required>
                    </div>
                    <div>
                        <label for="registration" class="flex items-center font-semibold text-gray-700 text-sm mb-1">
                            <img src="https://i.ibb.co/1frNTvW2/car.png" class="w-5 h-5 mr-2" alt="icon">
                            <span>ทะเบียนรถ</span>
                        </label>
                        <div class="input-group">
                            <input type="text" id="registration" name="registration" class="w-full p-2 input-field" placeholder="3กข-1234" required>
                            <div class="input-icons">
                                <div onclick="copyToClipboard('registration')" class="icon-btn" title="คัดลอก"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg></div>
                                <div onclick="clearInput('registration')" class="icon-btn" title="ลบ"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <label for="serviceDetail" class="flex items-center font-semibold text-gray-700 text-sm mb-1">
                        <img src="https://i.ibb.co/ymg6WDnX/tire.png" class="w-5 h-5 mr-2" alt="icon">
                        <span>รายละเอียดสินค้า</span>
                    </label>
                    <div class="input-group">
                        <textarea id="serviceDetail" name="serviceDetail" rows="3" class="w-full p-2 input-field" placeholder="เช่น 235/40R18 Pilot Sport 5 (4 เส้น)" required></textarea>
                         <div class="textarea-icons">
                            <div onclick="copyToClipboard('serviceDetail')" class="icon-btn" title="คัดลอก"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg></div>
                            <div onclick="clearInput('serviceDetail')" class="icon-btn" title="ลบ"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                     <div>
                        <label for="phone" class="flex items-center font-semibold text-gray-700 text-sm mb-1">
                            <img src="https://i.ibb.co/CgW0Bnb/smartphone.png" class="w-5 h-5 mr-2" alt="icon">
                            <span>เบอร์โทร</span>
                        </label>
                        <div class="input-group">
                            <input type="tel" id="phone" name="phone" oninput="formatPhoneNumber(event)" class="w-full p-2 input-field" placeholder="081-234-5678" required>
                             <div class="input-icons">
                                <div onclick="copyToClipboard('phone')" class="icon-btn" title="คัดลอก"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg></div>
                                <div onclick="clearInput('phone')" class="icon-btn" title="ลบ"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></div>
                            </div>
                        </div>
                    </div>
                     <div>
                        <label for="status" class="flex items-center font-semibold text-gray-700 text-sm mb-1">
                             <img src="https://i.ibb.co/WRhG1k3/ready-stock.png" class="w-5 h-5 mr-2" alt="icon">
                             <span>สถานะ</span>
                        </label>
                        <select id="status" name="status" class="w-full p-2 input-field">
                            <option>มีสินค้า</option>
                            <option>รอสั่งสินค้า</option>
                            <option>รอสินค้ามาส่ง</option>
                            <option>เช็คโกดัง</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div>
                        <label for="paymentMethod" class="flex items-center font-semibold text-gray-700 text-sm mb-1">
                            <img src="https://i.ibb.co/qYNQqSnc/money-flow.png" class="w-5 h-5 mr-2" alt="icon">
                            <span>วิธีชำระ</span>
                        </label>
                        <select id="paymentMethod" name="paymentMethod" class="w-full p-2 input-field">
                            <option>เงินสด/โอน</option>
                            <option>รูดบัตร</option>
                            <option>ผ่อน 6 เดือน</option>
                            <option>ผ่อน 10 เดือน</option>
                            <option>แจ้งที่หน้าร้าน</option>
                            <option>ชำระเงินแล้ว</option>
                        </select>
                    </div>
                    <div>
                        <label for="paymentAmount" class="flex items-center font-semibold text-gray-700 text-sm mb-1">
                            <img src="https://i.ibb.co/xtyrhGzc/money.png" class="w-5 h-5 mr-2" alt="icon">
                            <span>ยอดชำระ</span>
                        </label>
                        <div class="input-group">
                            <input type="text" inputmode="decimal" id="paymentAmount" name="paymentAmount" oninput="formatCurrency(event)" class="w-full p-2 input-field" placeholder="6,000">
                        </div>
                    </div>      
                </div>
                 <div>
                    <label for="pageSource" class="flex items-center font-semibold text-gray-700 text-sm mb-1">
                        <img src="https://i.ibb.co/0yMPWFb7/home.png" class="w-5 h-5 mr-2" alt="icon">
                        <span>เพจ</span>
                    </label>
                    <!-- [ไอเดีย 1] Dropdown รูปภาพจะถูกสร้างที่นี่ -->
                    <select id="pageSource" name="pageSource" placeholder="เลือกเพจ..."></select>
                </div>

                <div>
                    <label for="note" class="flex items-center font-semibold text-gray-700 text-sm mb-1">
                         <img src="https://i.ibb.co/mjFDjfS/more.png" class="w-5 h-5 mr-2" alt="icon">
                         <span>เพิ่มเติม</span>
                    </label>
                    <textarea id="note" name="note" rows="3" class="w-full p-2 input-field" placeholder="หมายเหตุเพิ่มเติม (ถ้ามี)"></textarea>
                </div>
            </div>
            
            <div class="form-footer border-t border-slate-200">
                <button type="submit" id="submit-button" class="w-full py-3 submit-btn">
                    บันทึกและส่งแจ้งเตือน
                </button>
            </div>
        </form>
    </div>

    <!-- [ไอเดีย 4] ส่วนแสดงผลสรุปข้อมูล -->
    <div id="success-message" class="hidden p-4 max-w-lg mx-auto">
        <div class="bg-white p-6 rounded-2xl shadow-lg text-center">
            <h2 class="text-2xl font-bold text-gray-800">ส่งข้อมูลสำเร็จ!</h2>
            <p class="mt-2 text-gray-600 mb-4">ระบบได้แจ้งเตือนทีมงานใน LINE แล้ว</p>
            <div id="summary-content" class="text-left text-sm bg-slate-50 p-4 rounded-lg border">
                <!-- Summary will be injected here -->
            </div>
            <p id="pc-notice" class="mt-4 text-xs text-gray-500 hidden">กรุณาปิดหน้าต่างนี้ด้วยตนเอง</p>
            <p id="mobile-notice" class="mt-4 text-xs text-gray-500">หน้าต่างนี้จะปิดอัตโนมัติ...</p>
        </div>
    </div>


    <div id="toast-notification" class="toast"></div>

    <script>
        // ============== CONFIG ==============
        const LIFF_ID = "2008056456-AE9jQjyw"; 
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycby6bqAZ_I1kzETf1l2dNlY6n-_SWp3hp8nQCXNMnlf-qabxjObFNkr091FN_gUiJxm7Ng/exec";
        // ==================================

        let userProfile = null;

        document.addEventListener("DOMContentLoaded", () => main());

        // [ไอเดีย 1] ตั้งค่าข้อมูลสำหรับ Dropdown รูปภาพ
        const pageOptions = [
            { value: '', text: '-- ไม่ระบุ --', image: 'https://i.ibb.co/GtnD9gP/no-image.png' },
            { value: 'A Little Wheel', text: 'A Little Wheel', image: 'https://img2.pic.in.th/pic/52717e2ac4e89fd96e544d19865224e5.jpg' },
            { value: 'Kodawari', text: 'Kodawari', image: 'https://img2.pic.in.th/pic/logo-kodawari.jpg' },
            { value: 'ยางถูกบางนา', text: 'ยางถูกบางนา', image: 'https://img5.pic.in.th/file/secure-sv1/logo-0158c0e1c3134fcf.jpg' },
        ];

        new TomSelect('#pageSource',{
            options: pageOptions,
            render: {
                option: function(data, escape) {
                    return `
                        <div class="flex items-center">
                            <img src="${escape(data.image)}" alt="${escape(data.text)}">
                            <span>${escape(data.text)}</span>
                        </div>
                    `;
                },
                item: function(data, escape) {
                    return `
                        <div class="flex items-center">
                            <img src="${escape(data.image)}" alt="${escape(data.text)}">
                            <span>${escape(data.text)}</span>
                        </div>
                    `;
                }
            }
        });


        async function main() {
            try {
                await liff.init({ liffId: LIFF_ID });

                if (liff.isInClient()) {
                    if (!liff.isLoggedIn()) {
                        liff.login();
                        return;
                    }
                    userProfile = await liff.getProfile();
                    document.getElementById('recorder-name-display').textContent = `โดย: ${userProfile.displayName}`;
                } else {
                    document.getElementById('recorder-name-display').style.display = 'none';
                    document.getElementById('manual-recorder-group').classList.remove('hidden');
                }
            } catch (err) {
                console.error("LIFF Init Error (or running in browser):", err);
                document.getElementById('recorder-name-display').style.display = 'none';
                document.getElementById('manual-recorder-group').classList.remove('hidden');
            } finally {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('liff-content').classList.remove('hidden');
            }
        }

        const form = document.getElementById('appointment-form');
        const submitButton = document.getElementById('submit-button');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            let recorderName;
            if (userProfile) {
                recorderName = userProfile.displayName;
            } else {
                recorderName = document.getElementById('manual-recorder-name').value;
                if (!recorderName.trim()) {
                    alert('กรุณากรอกชื่อผู้บันทึก');
                    return;
                }
            }

            submitButton.disabled = true;
            submitButton.textContent = 'กำลังส่ง...';

            const formData = new FormData(form);
            const data = {
                recorderName: recorderName,
                datetime: formData.get('datetime'),
                serviceDetail: formData.get('serviceDetail'),
                phone: formData.get('phone'),
                registration: formData.get('registration').toUpperCase(),
                status: formData.get('status'),
                paymentMethod: formData.get('paymentMethod'),
                paymentAmount: formData.get('paymentAmount') || 'N/A',
                pageSource: formData.get('pageSource') || 'ไม่ระบุ',
                note: formData.get('note') || '-',
            };
            
            try {
                await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                // [ไอเดีย 4] สร้างและแสดงสรุปข้อมูล
                const summaryContent = `
                    <p class="font-semibold text-gray-700">สรุปข้อมูลที่บันทึก:</p>
                    <ul class="list-disc list-inside mt-2 space-y-1 text-gray-600">
                        <li><b>ทะเบียน:</b> ${data.registration}</li>
                        <li><b>สินค้า:</b> ${data.serviceDetail}</li>
                        <li><b>สถานะ:</b> ${data.status}</li>
                        <li><b>ยอดชำระ:</b> ${data.paymentAmount}</li>
                        <li><b>โดย:</b> ${data.recorderName}</li>
                    </ul>
                `;
                document.getElementById('summary-content').innerHTML = summaryContent;
                document.getElementById('liff-content').style.display = 'none';
                document.getElementById('success-message').classList.remove('hidden');

                if (liff.isInClient()) {
                    setTimeout(() => liff.closeWindow(), 4000); // เพิ่มเวลาเป็น 4 วินาที
                } else {
                    document.getElementById('pc-notice').classList.remove('hidden');
                    document.getElementById('mobile-notice').style.display = 'none';
                }

            } catch (err) {
                console.error("Error sending data:", err);
                alert('เกิดข้อผิดพลาดในการส่งข้อมูล');
                submitButton.disabled = false;
                submitButton.textContent = 'บันทึกและส่งแจ้งเตือน';
            }
        });
        
        // --- Helper Functions (Unchanged) ---
        function formatPhoneNumber(event) {
            const input = event.target;
            let value = input.value.replace(/\D/g, '').substring(0, 10);
            if (value.length > 6) {
                input.value = `${value.substring(0,3)}-${value.substring(3,6)}-${value.substring(6)}`;
            } else if (value.length > 3) {
                input.value = `${value.substring(0,3)}-${value.substring(3)}`;
            } else {
                input.value = value;
            }
        }
        function formatCurrency(event) {
            const input = event.target;
            let value = input.value.replace(/\D/g, '');
            if (value) {
                input.value = new Intl.NumberFormat('en-US').format(value);
            } else {
                input.value = '';
            }
        }
        function clearInput(elementId) {
            document.getElementById(elementId).value = '';
        }
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const textToCopy = element.value;
            if (!textToCopy) return;
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = textToCopy;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            try {
                document.execCommand('copy');
                showToast('คัดลอกแล้ว!');
            } catch (err) {
                 console.error('Could not copy text: ', err);
            }
            document.body.removeChild(tempTextArea);
        }
        function resetForm() {
            form.reset();
            const manualNameInput = document.getElementById('manual-recorder-name');
            if (manualNameInput) {
                manualNameInput.value = '';
            }
            // Reset TomSelect dropdown
            const tomSelect = document.getElementById('pageSource').tomselect;
            if (tomSelect) {
                tomSelect.setValue('');
            }
            showToast('ล้างข้อมูลทั้งหมดแล้ว');
        }
        let toastTimer;
        function showToast(message) {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.classList.add('show');
            clearTimeout(toastTimer);
            toastTimer = setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }
    </script>
</body>
</html>
